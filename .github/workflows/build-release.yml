name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Run tests
      run: ./gradlew test

    - name: Run architecture tests
      run: ./gradlew test --tests "architecture.*"

  build-jar:
    needs: test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Build fat JAR
      run: ./gradlew clean shadowJar

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: BragLogBuddy-jar
        path: build/libs/BragLogBuddy-*.jar

  build-native:
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact-name: BragLogBuddy-linux
            executable-suffix: ""
          - os: windows-latest
            artifact-name: BragLogBuddy-windows
            executable-suffix: ".exe"
          - os: macos-latest
            artifact-name: BragLogBuddy-macos
            executable-suffix: ""

    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '21'
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Build native image
      run: ./gradlew nativeCompile

    - name: Upload native executable
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: build/native/nativeCompile/BragLogBuddy${{ matrix.executable-suffix }}

  build-installers:
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            installer-type: deb
            artifact-name: BragLogBuddy-installer-linux
          - os: windows-latest
            installer-type: exe
            artifact-name: BragLogBuddy-installer-windows
          - os: macos-latest
            installer-type: pkg
            artifact-name: BragLogBuddy-installer-macos

    runs-on: ${{ matrix.os }}
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Build fat JAR
      run: ./gradlew clean shadowJar

    - name: Get version
      id: get_version
      shell: bash
      run: |
        VERSION=$(./gradlew properties -q | grep "^version:" | cut -d' ' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create installer with jpackage
      shell: bash
      run: |
        mkdir -p dist
        jpackage \
          --input build/libs \
          --name "BragLogBuddy" \
          --main-jar BragLogBuddy-${{ steps.get_version.outputs.version }}.jar \
          --main-class MainKt \
          --dest dist \
          --type ${{ matrix.installer-type }} \
          --app-version ${{ steps.get_version.outputs.version }} \
          --description "A command line tool for journaling daily accomplishments" \
          --vendor "BragLogBuddy" \
          --copyright "2025 BragLogBuddy"

    - name: Upload installer
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: dist/*

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-jar, build-native, build-installers]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v6
      with:
        path: release-artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: release-artifacts/**/*
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref, '-') }}