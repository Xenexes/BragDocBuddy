name: Build and Release

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Workflow-level environment variables
env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'
  GRAALVM_VERSION: '21'
  APP_NAME: 'BragLogBuddy'
  APP_DESCRIPTION: 'A command line tool for journaling daily accomplishments'
  APP_VENDOR: 'BragLogBuddy'
  APP_COPYRIGHT: '2025 BragLogBuddy'

jobs:
  # ============================================================================
  # Version Job - Derives semantic version from conventional commits (Angular schema)
  # Outputs version to be used by all other jobs
  # Version is committed only in the release job after successful builds
  # ============================================================================
  version:
    name: Derive Version from Conventional Commits
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push initial tag if needed
    outputs:
      version: ${{ steps.semver.outputs.version }}
      version_tag: ${{ steps.semver.outputs.version_tag }}
      version_changed: ${{ steps.check_version.outputs.changed }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Required for full git history
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Ensure initial version tag exists
      run: |
        # Fetch all tags from remote
        git fetch --tags

        # Check if any version tags exist
        if ! git tag -l "v*" | grep -q .; then
          # No tags found, use version from gradle.properties as initial version
          INITIAL_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2)
          echo "No version tags found. Creating and pushing initial tag v$INITIAL_VERSION from gradle.properties"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "v$INITIAL_VERSION" -m "Initial version from gradle.properties"
          git push origin "v$INITIAL_VERSION"
          echo "âœ… Created and pushed initial tag v$INITIAL_VERSION"
        else
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)
          echo "Version tags already exist (latest: $LATEST_TAG), will use semantic versioning"
        fi

    - name: Derive semantic version (Angular schema)
      id: semver
      uses: paulhatch/semantic-version@v5.4.0
      with:
        # Angular Conventional Commits Schema
        tag_prefix: "v"
        major_pattern: "(BREAKING CHANGE:|\\w+!:)"  # BREAKING CHANGE or type!:
        minor_pattern: "(feat:|feature:)"           # feat: triggers minor bump
        version_format: "${major}.${minor}.${patch}"
        bump_each_commit: false
        search_commit_body: true
        user_format_type: "csv"

    - name: Display derived version
      run: |
        echo "ðŸ“¦ Derived version: ${{ steps.semver.outputs.version }}"
        echo "ðŸ·ï¸  Version tag: ${{ steps.semver.outputs.version_tag }}"
        echo ""
        echo "Conventional Commits (Angular schema):"
        echo "- feat: new feature â†’ minor version bump"
        echo "- fix: bug fix â†’ patch version bump"
        echo "- BREAKING CHANGE: or type!: â†’ major version bump"
        echo "- docs:, style:, refactor:, perf:, test:, chore: â†’ no version bump"

    - name: Check if version changed
      id: check_version
      run: |
        NEW_VERSION="${{ steps.semver.outputs.version }}"
        CURRENT_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2)

        echo "Current version in gradle.properties: $CURRENT_VERSION"
        echo "Derived version from commits: $NEW_VERSION"

        if [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "âœ… Version will be updated: $CURRENT_VERSION â†’ $NEW_VERSION"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "â„¹ï¸  Version unchanged: $CURRENT_VERSION"
        fi

  # ============================================================================
  # Check Job - Runs all verification tasks (tests, ktlint, architecture tests)
  # Version is set locally from the version job output
  # ============================================================================
  check:
    name: Run Checks (Tests, ktlint, etc.)
    needs: version
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK
      uses: actions/setup-java@v5
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        cache-read-only: false
        gradle-home-cache-includes: |
          caches
          notifications
          wrapper

    - name: Set version from conventional commits
      run: |
        echo "Running checks with version: ${{ needs.version.outputs.version }}"
        # Update version in gradle.properties (preserving other properties)
        # Cross-platform sed: create backup and remove it (works on both Linux and macOS)
        if grep -q "^version=" gradle.properties; then
          sed -i.bak "s/^version=.*/version=${{ needs.version.outputs.version }}/" gradle.properties && rm gradle.properties.bak
        else
          echo "version=${{ needs.version.outputs.version }}" >> gradle.properties
        fi
        echo "Updated gradle.properties:"
        cat gradle.properties

    - name: Run all checks (tests, ktlint, etc.)
      run: ./gradlew check

  # ============================================================================
  # Build JAR - Creates universal fat JAR using derived version
  # Version is set locally from the version job output
  # ============================================================================
  build-jar:
    name: Build Fat JAR
    needs: [version, check]
    runs-on: ubuntu-latest
    outputs:
      version: ${{ needs.version.outputs.version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK
      uses: actions/setup-java@v5
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        cache-read-only: false
        gradle-home-cache-includes: |
          caches
          notifications
          wrapper

    - name: Set version from conventional commits
      run: |
        echo "Building version: ${{ needs.version.outputs.version }}"
        # Update version in gradle.properties (preserving other properties)
        # Cross-platform sed: create backup and remove it (works on both Linux and macOS)
        if grep -q "^version=" gradle.properties; then
          sed -i.bak "s/^version=.*/version=${{ needs.version.outputs.version }}/" gradle.properties && rm gradle.properties.bak
        else
          echo "version=${{ needs.version.outputs.version }}" >> gradle.properties
        fi
        echo "Updated gradle.properties:"
        cat gradle.properties

    - name: Build fat JAR
      run: ./gradlew clean shadowJar

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v5
      with:
        name: ${{ env.APP_NAME }}-jar
        path: build/libs/${{ env.APP_NAME }}-*.jar
        # Main branch: 90 days (backup), Feature branches/PRs: 14 days (testing/debugging)
        retention-days: ${{ github.ref == 'refs/heads/main' && 90 || 14 }}

  # ============================================================================
  # Build Native Images - Creates platform-specific native executables
  # Version is set locally from the version job output
  # ============================================================================
  build-native:
    name: Build Native Image (${{ matrix.platform }})
    needs: [version, check]
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            artifact-name: BragLogBuddy-linux
            executable-suffix: ""
          - os: windows-latest
            platform: Windows
            artifact-name: BragLogBuddy-windows
            executable-suffix: ".exe"
          - os: macos-latest
            platform: macOS
            artifact-name: BragLogBuddy-macos
            executable-suffix: ""

    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: ${{ env.GRAALVM_VERSION }}
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}
        cache: 'gradle'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        cache-read-only: false
        gradle-home-cache-includes: |
          caches
          notifications
          wrapper

    - name: Set version from conventional commits
      shell: bash
      run: |
        echo "Building version: ${{ needs.version.outputs.version }}"
        # Update version in gradle.properties (preserving other properties)
        # Cross-platform sed: create backup and remove it (works on both Linux and macOS)
        if grep -q "^version=" gradle.properties; then
          sed -i.bak "s/^version=.*/version=${{ needs.version.outputs.version }}/" gradle.properties && rm gradle.properties.bak
        else
          echo "version=${{ needs.version.outputs.version }}" >> gradle.properties
        fi
        echo "Updated gradle.properties:"
        cat gradle.properties

    - name: Configure temp directory for Windows native build
      if: runner.os == 'Windows'
      shell: bash
      run: |
        # Workaround for GraalVM plugin path issue on Windows
        # See: https://github.com/graalvm/native-build-tools/issues/754
        echo "" >> gradle.properties  # Ensure newline
        echo "org.gradle.jvmargs=-Djava.io.tmpdir=D:/temp" >> gradle.properties
        mkdir -p D:/temp
        echo "Configured temp directory for Windows build"
        echo "Updated gradle.properties:"
        cat gradle.properties

    - name: Build native image
      run: ./gradlew nativeCompile

    - name: Upload native executable
      uses: actions/upload-artifact@v5
      with:
        name: ${{ matrix.artifact-name }}
        path: build/native/nativeCompile/${{ env.APP_NAME }}${{ matrix.executable-suffix }}
        retention-days: ${{ github.ref == 'refs/heads/main' && 90 || 14 }}

  # ============================================================================
  # Build Installers - Creates platform-specific installers using jpackage
  # Reuses JAR artifact from build-jar job to avoid rebuilding
  # ============================================================================
  build-installers:
    name: Build Installer (${{ matrix.platform }})
    needs: build-jar
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Linux
            installer-type: deb
            artifact-name: BragLogBuddy-installer-linux
          - os: windows-latest
            platform: Windows
            installer-type: exe
            artifact-name: BragLogBuddy-installer-windows
          - os: macos-latest
            platform: macOS
            installer-type: pkg
            artifact-name: BragLogBuddy-installer-macos

    runs-on: ${{ matrix.os }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up JDK
      uses: actions/setup-java@v5
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: ${{ env.JAVA_DISTRIBUTION }}

    - name: Download JAR artifact
      uses: actions/download-artifact@v6
      with:
        name: ${{ env.APP_NAME }}-jar
        path: build/libs

    - name: Sanitize version for jpackage
      id: sanitize_version
      shell: bash
      run: |
        # jpackage requires version format: major[.minor[.build]]
        # Remove -SNAPSHOT and other non-numeric suffixes
        VERSION="${{ needs.build-jar.outputs.version }}"
        CLEAN_VERSION=$(echo "$VERSION" | sed 's/-SNAPSHOT//' | sed 's/-.*$//' | sed 's/[^0-9.]//g')

        # Ensure version has at least major.minor format
        if [[ ! "$CLEAN_VERSION" =~ ^[0-9]+\.[0-9]+(\.[0-9]+)?$ ]]; then
          CLEAN_VERSION="1.0.0"
        fi

        echo "Original version: $VERSION"
        echo "Sanitized version: $CLEAN_VERSION"
        echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT

    - name: Create installer with jpackage
      shell: bash
      run: |
        mkdir -p dist
        jpackage \
          --input build/libs \
          --name "${{ env.APP_NAME }}" \
          --main-jar ${{ env.APP_NAME }}-${{ needs.build-jar.outputs.version }}.jar \
          --main-class MainKt \
          --dest dist \
          --type ${{ matrix.installer-type }} \
          --app-version ${{ steps.sanitize_version.outputs.clean_version }} \
          --description "${{ env.APP_DESCRIPTION }}" \
          --vendor "${{ env.APP_VENDOR }}" \
          --copyright "${{ env.APP_COPYRIGHT }}"

    - name: Upload installer
      uses: actions/upload-artifact@v5
      with:
        name: ${{ matrix.artifact-name }}
        path: dist/*
        retention-days: ${{ github.ref == 'refs/heads/main' && 90 || 14 }}

  # ============================================================================
  # Release Job - Publishes all artifacts to GitHub Releases
  # Automatically runs on main branch when version changes
  # Commits the version update to gradle.properties before creating the release
  # The release action automatically creates the git tag
  # This only runs if all tests and builds succeed
  # ============================================================================
  release:
    name: Create GitHub Release
    if: |
      needs.version.outputs.version_changed == 'true' &&
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push'
    needs: [version, build-jar, build-native, build-installers]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update and commit version to gradle.properties
      run: |
        NEW_VERSION="${{ needs.version.outputs.version }}"
        CURRENT_VERSION=$(grep "^version=" gradle.properties | cut -d'=' -f2)

        echo "Updating gradle.properties: $CURRENT_VERSION â†’ $NEW_VERSION"

        # Update version in gradle.properties
        sed -i.bak "s/^version=.*/version=$NEW_VERSION/" gradle.properties && rm gradle.properties.bak

        # Configure git
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Commit and push
        git add gradle.properties
        git commit -m "chore: update version to $NEW_VERSION"
        git push

        echo "âœ… Version committed to repository"

    - name: Download all artifacts
      uses: actions/download-artifact@v6
      with:
        path: release-artifacts

    - name: Reorganize artifacts with platform-specific names
      working-directory: release-artifacts
      run: |
        # Create a flat structure with platform-specific names for native executables
        mkdir -p final

        # Copy JAR
        find . -name "*.jar" -exec cp {} final/ \;

        # Copy and rename native executables to include platform
        if [ -f BragLogBuddy-linux/BragLogBuddy ]; then
          cp BragLogBuddy-linux/BragLogBuddy final/BragLogBuddy-linux
        fi

        if [ -f BragLogBuddy-macos/BragLogBuddy ]; then
          cp BragLogBuddy-macos/BragLogBuddy final/BragLogBuddy-macos
        fi

        if [ -f BragLogBuddy-windows/BragLogBuddy.exe ]; then
          cp BragLogBuddy-windows/BragLogBuddy.exe final/BragLogBuddy-windows.exe
        fi

        # Copy installers
        find . -name "*.deb" -exec cp {} final/ \;
        find . -name "*.exe" -exec cp {} final/ \;
        find . -name "*.pkg" -exec cp {} final/ \;

        echo "Reorganized artifacts:"
        ls -lh final/

    - name: Generate checksums
      working-directory: release-artifacts/final
      run: |
        echo "# SHA256 Checksums" > checksums.txt
        echo "" >> checksums.txt
        sha256sum * | grep -v checksums.txt >> checksums.txt
        echo ""
        echo "Generated checksums:"
        cat checksums.txt

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ needs.version.outputs.version }}
        name: Release v${{ needs.version.outputs.version }}
        files: release-artifacts/final/*
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(needs.version.outputs.version, '-') }}
        fail_on_unmatched_files: false
        body: |
          ## Release v${{ needs.version.outputs.version }}

          Automated release created from conventional commits on main branch.

          ### Installation

          Download the appropriate artifact for your platform:

          #### Universal JAR (All platforms)
          - `BragLogBuddy-${{ needs.version.outputs.version }}.jar` - Requires Java 21+

          #### Native Executables (no Java required)
          - **Linux**: `BragLogBuddy-linux`
          - **Windows**: `BragLogBuddy-windows.exe`
          - **macOS**: `BragLogBuddy-macos`

          #### Platform Installers
          - **Linux**: `braglogbuddy_${{ needs.version.outputs.version }}_amd64.deb`
          - **Windows**: `BragLogBuddy-${{ needs.version.outputs.version }}.exe`
          - **macOS**: `BragLogBuddy-${{ needs.version.outputs.version }}.pkg`

          ### Verification

          All artifacts include SHA256 checksums in `checksums.txt` for verification.